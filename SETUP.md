# üöÄ Unread Backend Setup Guide

This guide will walk you through setting up the Unread backend for development and production.

## üìã Prerequisites

- **Python 3.11+** (check with `python3 --version`)
- **Git** for version control
- **Supabase account** for database and file storage
- **Railway account** (for production deployment)

## üèóÔ∏è What is Alembic?

**Alembic** is a database migration tool that helps you:

- **Track database changes**: Like Git for your database schema
- **Version control**: Apply changes incrementally and safely
- **Team collaboration**: Everyone gets the same database structure
- **Rollback capability**: Undo changes if something goes wrong

### Alembic Workflow:
```bash
# 1. Make changes to your models (e.g., add a field to User)
# 2. Generate migration file
alembic revision --autogenerate -m "Add new field to User"

# 3. Review the generated migration file
# 4. Apply migration to database
alembic upgrade head

# 5. If needed, rollback
alembic downgrade -1
```

## üîß Environment Setup

### 1. **Quick Setup (Automated)**

Run the setup script:

```bash
# Clone your repository
git clone <your-repo-url>
cd backend

# Run automated setup
python3 scripts/setup.py
```

This will:
- Create virtual environment
- Install dependencies
- Generate `.env` file with secure secret key
- Set up database migrations

### 2. **Manual Setup**

If you prefer manual setup:

```bash
# 1. Create virtual environment
python3 -m venv venv

# 2. Activate virtual environment
source venv/bin/activate  # On macOS/Linux
# venv\Scripts\activate   # On Windows

# 3. Install dependencies
pip install -r requirements.txt

# 4. Copy environment file
cp env.example .env

# 5. Edit .env with your credentials (see below)
```

## üóÑÔ∏è Database Setup (Supabase)

### Creating Two Environments

**Option 1: Two Separate Projects (Recommended)**

1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Create **Development Project**:
   - Name: `unread-dev`
   - Region: Choose closest to you
   - Database password: Save this securely
3. Create **Production Project**:
   - Name: `unread-prod`
   - Region: Same as development
   - Database password: Different from dev

### Getting Supabase Credentials

For each project, go to **Settings > API**:

```bash
# You'll need these values:
Project URL: https://your-project-id.supabase.co
anon/public key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
service_role key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

For database URL, go to **Settings > Database**:
```bash
# Connection string format:
postgresql+asyncpg://postgres:your-password@db.your-project-id.supabase.co:5432/postgres
```

## ‚öôÔ∏è Environment Configuration

### Development Environment

Edit your `.env` file:

```bash
# Database (Development Supabase project)
DATABASE_URL=postgresql+asyncpg://postgres:your-dev-password@db.your-dev-project.supabase.co:5432/postgres

# Security
SECRET_KEY=your-generated-secret-key  # Already generated by setup script

# Supabase (Development project)
SUPABASE_URL=https://your-dev-project.supabase.co
SUPABASE_ANON_KEY=your-dev-anon-key
SUPABASE_SERVICE_KEY=your-dev-service-key

# Environment
ENVIRONMENT=development
```

### Production Environment (Railway)

In Railway dashboard, set these environment variables:

```bash
# Database (Production Supabase project)
DATABASE_URL=postgresql+asyncpg://postgres:your-prod-password@db.your-prod-project.supabase.co:5432/postgres

# Security (Generate new secure key for production)
SECRET_KEY=your-super-secure-production-key

# Supabase (Production project)
SUPABASE_URL=https://your-prod-project.supabase.co
SUPABASE_ANON_KEY=your-prod-anon-key
SUPABASE_SERVICE_KEY=your-prod-service-key

# CORS (Your actual domain)
BACKEND_CORS_ORIGINS=https://your-app.com

# Environment
ENVIRONMENT=production
```

## üóÉÔ∏è Database Migration Setup

### Initial Setup

```bash
# Activate virtual environment
source venv/bin/activate

# Create initial migration
alembic revision --autogenerate -m "Initial migration"

# Apply migration to database
alembic upgrade head
```

### Common Alembic Commands

```bash
# Create new migration after model changes
alembic revision --autogenerate -m "Description of changes"

# Apply all pending migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# See migration history
alembic history

# See current migration version
alembic current
```

## üöÄ Running the Application

### Development

```bash
# Activate virtual environment
source venv/bin/activate

# Run with auto-reload
python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Or use the shorthand
uvicorn app.main:app --reload
```

Visit:
- **API Documentation**: http://localhost:8000/docs
- **Alternative Docs**: http://localhost:8000/redoc
- **Health Check**: http://localhost:8000/health

### Production (Railway)

Railway will automatically:
1. Detect your Python app
2. Install dependencies from `requirements.txt`
3. Run the command from `Procfile`
4. Use environment variables you set in dashboard

## üß™ Testing

```bash
# Run all tests
python3 -m pytest

# Run with coverage
python3 -m pytest --cov=app

# Run specific test file
python3 -m pytest tests/test_main.py

# Run with verbose output
python3 -m pytest -v
```

## üîß Development Workflow

### Adding New Features

1. **Create/modify models** in `app/models/`
2. **Generate migration**:
   ```bash
   alembic revision --autogenerate -m "Add new feature"
   ```
3. **Review migration file** in `alembic/versions/`
4. **Apply migration**:
   ```bash
   alembic upgrade head
   ```
5. **Create schemas** in `app/schemas/`
6. **Create services** in `app/services/`
7. **Create endpoints** in `app/api/v1/endpoints/`
8. **Add tests** in `tests/`

### Code Quality

```bash
# Format code
python3 -m black app/

# Sort imports
python3 -m isort app/

# Lint code
python3 -m flake8 app/

# Run all quality checks
python3 -m black app/ && python3 -m isort app/ && python3 -m flake8 app/
```

## üö® Troubleshooting

### Common Issues

1. **"ModuleNotFoundError"**
   ```bash
   # Make sure virtual environment is activated
   source venv/bin/activate
   pip install -r requirements.txt
   ```

2. **Database connection errors**
   ```bash
   # Check your DATABASE_URL in .env
   # Make sure Supabase project is running
   # Verify credentials are correct
   ```

3. **Migration errors**
   ```bash
   # Check if database exists and is accessible
   # Verify DATABASE_URL format
   # Try creating migration manually:
   alembic revision -m "Manual migration"
   ```

4. **Import errors in Alembic**
   ```bash
   # Make sure all models are imported in alembic/env.py
   # Check that PYTHONPATH includes your project root
   ```

## üìö Next Steps

1. **Set up your Supabase projects**
2. **Configure your environment variables**
3. **Run the initial migration**
4. **Test the API endpoints**
5. **Start implementing your features**

## üÜò Getting Help

- Check the [FastAPI documentation](https://fastapi.tiangolo.com/)
- Review [Alembic documentation](https://alembic.sqlalchemy.org/)
- Look at [Supabase documentation](https://supabase.com/docs)
- Check the API docs at `/docs` when running locally 